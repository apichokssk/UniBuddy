

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniBuddy - Connect & Exchange Skills</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'uni-blue': '#1e40af',
                        'uni-purple': '#7c3aed',
                        'uni-pink': '#ec4899'
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, doc, setDoc, getDoc, deleteDoc, updateDoc, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzM10aWhH7Y8ECkB6i64kSA-HJtziZjPQ",
            authDomain: "porpa-7f72a.firebaseapp.com",
            projectId: "porpa-7f72a",
            storageBucket: "porpa-7f72a.firebasestorage.app",
            messagingSenderId: "499247336738",
            appId: "1:499247336738:web:53286e821adede4019297b",
            measurementId: "G-LVBT2WLLT3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const analytics = getAnalytics(app);

        // Make Firebase available globally
        window.firebase = { auth, db, storage, analytics };
        window.firebaseAuth = { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged };
        window.firebaseFirestore = { collection, addDoc, getDocs, query, where, orderBy, doc, setDoc, getDoc, deleteDoc, updateDoc, serverTimestamp, onSnapshot };
        window.firebaseStorage = { ref, uploadBytes, getDownloadURL };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .skill-tag { background: linear-gradient(45deg, #667eea, #764ba2); }
        .post-card { transition: all 0.3s ease; }
        .post-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .notification-badge { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .page { display: none; }
        .page.active { display: block; }
        .nav-item.active { background: linear-gradient(to right, #1e40af, #7c3aed) !important; color: white !important; }
        .chat-message { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .auth-required { display: none; }
        .auth-required.show { display: block; }
        .loading { display: none; }
        .loading.show { display: flex; }
        .auth-form { 
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-uni-blue mx-auto mb-4"></div>
            <p class="text-gray-600">Loading...</p>
        </div>
    </div>

    <!-- Authentication Pages -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-purple-50 px-4">
        <!-- Sign In Form -->
        <div id="signin-form" class="auth-form bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-16 h-16 gradient-bg rounded-2xl flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4">
                    UB
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Welcome Back!</h1>
                <p class="text-gray-600">Sign in to continue your skill exchange journey</p>
            </div>

            <form id="signin-form-element" class="space-y-6">
                <div id="signin-error" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm"></div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="signin-email" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent transition-colors"
                           placeholder="your.email@university.edu">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="signin-password" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent transition-colors"
                           placeholder="Enter your password">
                </div>
                
                <button type="submit" id="signin-btn" 
                        class="w-full bg-gradient-to-r from-uni-blue to-uni-purple text-white py-3 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-300 font-medium">
                    Sign In
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-gray-600">Don't have an account? 
                    <button id="show-signup" class="text-uni-blue hover:text-blue-700 font-medium">Sign up here</button>
                </p>
            </div>
        </div>

        <!-- Sign Up Form -->
        <div id="signup-form" class="auth-form bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-8 w-full max-w-md hidden">
            <div class="text-center mb-8">
                <div class="w-16 h-16 gradient-bg rounded-2xl flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4">
                    UB
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Join UniBuddy</h1>
                <p class="text-gray-600">Create your account and start exchanging skills</p>
            </div>

            <form id="signup-form-element" class="space-y-6">
                <div id="signup-error" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm"></div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="signup-name" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent transition-colors"
                           placeholder="Your full name">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="signup-email" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent transition-colors"
                           placeholder="your.email@university.edu">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Faculty/Major</label>
                    <input type="text" id="signup-faculty" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent transition-colors"
                           placeholder="e.g., Computer Science">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="signup-password" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent transition-colors"
                           placeholder="Create a strong password">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent transition-colors"
                           placeholder="Confirm your password">
                </div>
                
                <button type="submit" id="signup-btn" 
                        class="w-full bg-gradient-to-r from-uni-purple to-uni-pink text-white py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all duration-300 font-medium">
                    Create Account
                </button>
            </form>

            <div class="mt-6 text-center">
                <p class="text-gray-600">Already have an account? 
                    <button id="show-signin" class="text-uni-blue hover:text-blue-700 font-medium">Sign in here</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until authenticated) -->
    <div id="main-app" class="auth-required">
        <!-- Desktop/Tablet Sidebar -->
        <div class="fixed left-0 top-0 h-full bg-white border-r border-gray-200 z-40 hidden md:flex flex-col w-16 lg:w-64 transition-all duration-300">
            <!-- Logo -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center">
                    <div class="w-8 h-8 gradient-bg rounded-lg flex items-center justify-center text-white font-bold text-sm">
                        UB
                    </div>
                    <span class="ml-3 font-bold text-xl text-gray-800 hidden lg:block">UniBuddy</span>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="flex-1 p-4">
                <ul class="space-y-2">
                    <li>
                        <a href="#" data-page="home" class="nav-item active flex items-center p-3 rounded-lg bg-gradient-to-r from-uni-blue to-uni-purple text-white">
                            <i class="fas fa-home text-lg"></i>
                            <span class="ml-3 hidden lg:block">Home</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="explore" class="nav-item flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors">
                            <i class="fas fa-search text-lg"></i>
                            <span class="ml-3 hidden lg:block">Explore</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="create" class="nav-item flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors">
                            <i class="fas fa-plus-circle text-lg"></i>
                            <span class="ml-3 hidden lg:block">Create Post</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="messages" class="nav-item flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors relative">
                            <i class="fas fa-comments text-lg"></i>
                            <span class="ml-3 hidden lg:block">Messages</span>
                            <span id="message-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center notification-badge hidden">0</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="myposts" class="nav-item flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors">
                            <i class="fas fa-file-alt text-lg"></i>
                            <span class="ml-3 hidden lg:block">My Posts</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="profile" class="nav-item flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors">
                            <i class="fas fa-user text-lg"></i>
                            <span class="ml-3 hidden lg:block">Profile</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="dashboard" class="nav-item flex items-center p-3 rounded-lg text-gray-600 hover:bg-gray-100 transition-colors">
                            <i class="fas fa-chart-bar text-lg"></i>
                            <span class="ml-3 hidden lg:block">Dashboard</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <!-- User Profile -->
            <div class="p-4 border-t border-gray-200 hidden lg:block">
                <div class="flex items-center">
                    <div id="user-avatar" class="w-10 h-10 bg-gradient-to-r from-uni-pink to-uni-purple rounded-full flex items-center justify-center text-white font-semibold">
                        U
                    </div>
                    <div class="ml-3 flex-1">
                        <p id="user-name" class="font-semibold text-gray-800">Loading...</p>
                        <p id="user-faculty" class="text-sm text-gray-500">Student</p>
                    </div>
                    <button id="logout-btn" class="text-gray-400 hover:text-red-500 transition-colors">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Bottom Navigation -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50 md:hidden">
            <div class="flex justify-around items-center h-16">
                <a href="#" data-page="home" class="mobile-nav flex flex-col items-center p-2 text-uni-blue">
                    <i class="fas fa-home text-xl"></i>
                    <span class="text-xs mt-1">Home</span>
                </a>
                <a href="#" data-page="explore" class="mobile-nav flex flex-col items-center p-2 text-gray-500">
                    <i class="fas fa-search text-xl"></i>
                    <span class="text-xs mt-1">Search</span>
                </a>
                <a href="#" data-page="create" class="mobile-nav flex flex-col items-center p-2 text-gray-500">
                    <i class="fas fa-plus-circle text-xl"></i>
                    <span class="text-xs mt-1">Create</span>
                </a>
                <a href="#" data-page="messages" class="mobile-nav flex flex-col items-center p-2 text-gray-500 relative">
                    <i class="fas fa-comments text-xl"></i>
                    <span class="text-xs mt-1">Messages</span>
                </a>
                <a href="#" data-page="profile" class="mobile-nav flex flex-col items-center p-2 text-gray-500">
                    <i class="fas fa-user text-xl"></i>
                    <span class="text-xs mt-1">Profile</span>
                </a>
            </div>
        </div>

        <!-- Main Content Container -->
        <div class="md:ml-16 lg:ml-64 min-h-screen pb-20 md:pb-0">
            
            <!-- HOME PAGE -->
            <div id="home-page" class="page active">
                <div class="max-w-6xl mx-auto px-4 py-6">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Main Feed -->
                        <div class="lg:col-span-3">
                            <!-- Header -->
                            <div class="mb-6">
                                <h1 class="text-2xl font-bold text-gray-800 mb-2">Welcome back! 👋</h1>
                                <p class="text-gray-600">Discover new skill exchange opportunities</p>
                            </div>

                            <!-- Filters -->
                            <div class="bg-white rounded-xl p-4 mb-6 shadow-sm border border-gray-100">
                                <div class="flex flex-wrap gap-4 items-center">
                                    <select id="home-type-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                        <option value="">All Posts</option>
                                        <option value="need">Need Help</option>
                                        <option value="offer">Offering Help</option>
                                    </select>
                                    <select id="home-sort-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                        <option value="recent">Sort by Recent</option>
                                        <option value="popular">Sort by Popular</option>
                                    </select>
                                    <button id="apply-filters" class="bg-uni-blue text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                        Apply Filters
                                    </button>
                                </div>
                            </div>

                            <!-- Feed Posts -->
                            <div id="posts-container" class="space-y-6">
                                <div class="text-center py-8">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-uni-blue mx-auto mb-4"></div>
                                    <p class="text-gray-600">Loading posts...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Right Sidebar (Desktop only) -->
                        <div class="hidden lg:block">
                            <!-- Quick Stats -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 mb-6">
                                <h3 class="font-semibold text-gray-800 mb-4">Your Activity</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Posts Created</span>
                                        <span id="user-posts-count" class="font-semibold">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Connections</span>
                                        <span id="user-connections-count" class="font-semibold">0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Popular Skills -->
                            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                                <h3 class="font-semibold text-gray-800 mb-4">Trending Skills</h3>
                                <div class="space-y-2" id="trending-skills">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">JavaScript</span>
                                        <span class="text-xs text-gray-400">24 posts</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Python</span>
                                        <span class="text-xs text-gray-400">18 posts</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm text-gray-600">Design</span>
                                        <span class="text-xs text-gray-400">15 posts</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXPLORE PAGE -->
            <div id="explore-page" class="page">
                <div class="max-w-4xl mx-auto px-4 py-6">
                    <div class="mb-6">
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">Explore Skills</h1>
                        <p class="text-gray-600">Find exactly what you're looking for</p>
                    </div>

                    <!-- Search Bar -->
                    <div class="bg-white rounded-xl p-6 mb-6 shadow-sm border border-gray-100">
                        <div class="relative mb-4">
                            <input type="text" id="search-input" placeholder="Search for skills, subjects, or keywords..." 
                                   class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <select id="category-filter" class="border border-gray-300 rounded-lg px-3 py-2">
                                <option value="">All Types</option>
                                <option value="need">Need Help</option>
                                <option value="offer">Offering Help</option>
                            </select>
                            <input type="text" id="tags-filter" placeholder="Tags (e.g., Python)" 
                                   class="border border-gray-300 rounded-lg px-3 py-2">
                            <select id="sort-filter" class="border border-gray-300 rounded-lg px-3 py-2">
                                <option value="recent">Recent First</option>
                                <option value="oldest">Oldest First</option>
                            </select>
                            <button id="search-btn" class="bg-uni-blue text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                Search
                            </button>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div id="search-results" class="space-y-6">
                        <div class="text-center py-8">
                            <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                            <h3 class="text-lg font-semibold text-gray-600 mb-2">Start your search</h3>
                            <p class="text-gray-500">Use the search bar above to find posts</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CREATE POST PAGE -->
            <div id="create-page" class="page">
                <div class="max-w-2xl mx-auto px-4 py-6">
                    <div class="mb-6">
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">Create New Post</h1>
                        <p class="text-gray-600">Share what you need help with or what you can offer</p>
                    </div>

                    <form id="create-post-form" class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Post Type</label>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-uni-blue transition-colors">
                                    <input type="radio" name="post-type" value="need" class="mr-3" checked>
                                    <div>
                                        <div class="font-medium text-gray-800">Need Help</div>
                                        <div class="text-sm text-gray-500">I need assistance with something</div>
                                    </div>
                                </label>
                                <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-uni-blue transition-colors">
                                    <input type="radio" name="post-type" value="offer" class="mr-3">
                                    <div>
                                        <div class="font-medium text-gray-800">Offer Help</div>
                                        <div class="text-sm text-gray-500">I can help others with something</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input type="text" id="post-title" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent"
                                   placeholder="Brief description of what you need/offer">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="post-description" rows="4" required
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent"
                                      placeholder="Provide more details about your request or offer..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Skills/Tags</label>
                            <input type="text" id="post-skills" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent"
                                   placeholder="e.g., Python, Web Design, Mathematics (separate with commas)">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">What I can offer in return</label>
                            <textarea id="post-exchange" rows="2"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent"
                                      placeholder="What skills or help can you provide in exchange?"></textarea>
                        </div>

                        <button type="submit" class="w-full bg-uni-blue text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                            Create Post
                        </button>
                    </form>
                </div>
            </div>

            <!-- MY POSTS PAGE -->
            <div id="myposts-page" class="page">
                <div class="max-w-4xl mx-auto px-4 py-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800 mb-2">My Posts</h1>
                            <p class="text-gray-600">Manage your skill exchange posts</p>
                        </div>
                        <button data-page="create" class="nav-trigger bg-uni-blue text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>New Post
                        </button>
                    </div>

                    <div id="my-posts-container" class="space-y-6">
                        <div class="text-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-uni-blue mx-auto mb-4"></div>
                            <p class="text-gray-600">Loading your posts...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MESSAGES PAGE -->
            <div id="messages-page" class="page">
                <div class="max-w-6xl mx-auto px-4 py-6 h-screen flex flex-col">
                    <!-- Desktop Header -->
                    <div class="mb-6 hidden lg:block">
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">Messages</h1>
                        <p class="text-gray-600">Connect with your skill exchange partners</p>
                    </div>

                    <!-- Mobile Header (Conversations) -->
                    <div id="mobile-conversations-header" class="mb-4 lg:hidden">
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">Messages</h1>
                        <p class="text-gray-600">Your conversations</p>
                    </div>

                    <!-- Mobile Header (Chat) -->
                    <div id="mobile-chat-header" class="mb-4 lg:hidden hidden">
                        <div class="flex items-center">
                            <button id="back-to-conversations" class="mr-3 p-2 text-uni-blue hover:bg-blue-50 rounded-lg transition-colors">
                                <i class="fas fa-arrow-left text-lg"></i>
                            </button>
                            <div id="mobile-chat-user-avatar" class="w-10 h-10 bg-gradient-to-r from-uni-pink to-uni-purple rounded-full flex items-center justify-center text-white font-semibold">
                                U
                            </div>
                            <div class="ml-3">
                                <h3 id="mobile-chat-user-name" class="font-semibold text-gray-800">User Name</h3>
                                <p id="mobile-chat-user-faculty" class="text-sm text-gray-500">Faculty</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                        <!-- Chat List -->
                        <div id="conversations-panel" class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-gray-100 flex flex-col h-[calc(100vh-200px)] lg:h-[calc(100vh-200px)]">
                            <div class="p-4 border-b border-gray-200 flex-shrink-0 hidden lg:block">
                                <h3 class="font-semibold text-gray-800">Conversations</h3>
                            </div>
                            <div id="chat-list" class="flex-1 overflow-y-auto">
                                <div class="p-4 text-center text-gray-500">
                                    <i class="fas fa-comments text-2xl mb-2"></i>
                                    <p class="text-sm">No conversations yet</p>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Window -->
                        <div id="chat-panel" class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 flex-col h-[calc(100vh-200px)] lg:h-[calc(100vh-200px)] hidden lg:flex">
                            <div id="chat-header" class="p-4 border-b border-gray-200 hidden flex-shrink-0">
                                <div class="flex items-center">
                                    <div id="chat-user-avatar" class="w-10 h-10 bg-gradient-to-r from-uni-pink to-uni-purple rounded-full flex items-center justify-center text-white font-semibold">
                                        U
                                    </div>
                                    <div class="ml-3">
                                        <h3 id="chat-user-name" class="font-semibold text-gray-800">User Name</h3>
                                        <p id="chat-user-faculty" class="text-sm text-gray-500">Faculty</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 min-h-0">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-comment text-4xl mb-4"></i>
                                    <h3 class="text-lg font-semibold mb-2">Start a conversation</h3>
                                    <p>Select a chat from the list or connect with someone from a post</p>
                                </div>
                            </div>
                            
                            <div id="chat-input-container" class="p-4 border-t border-gray-200 hidden flex-shrink-0">
                                <form id="send-message-form" class="flex space-x-2">
                                    <input type="file" id="image-input" accept="image/*" class="hidden">
                                    <button type="button" id="attach-btn" class="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <input type="text" id="message-input" placeholder="Type your message..." 
                                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent">
                                    <button type="submit" class="bg-uni-blue text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Mobile Chat Window -->
                        <div id="mobile-chat-panel" class="lg:hidden bg-white rounded-xl shadow-sm border border-gray-100 flex-col h-[calc(100vh-200px)] hidden">
                            <div id="mobile-chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 min-h-0">
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-comment text-4xl mb-4"></i>
                                    <h3 class="text-lg font-semibold mb-2">Start a conversation</h3>
                                    <p>Select a chat from the list or connect with someone from a post</p>
                                </div>
                            </div>
                            
                            <div id="mobile-chat-input-container" class="p-4 border-t border-gray-200 hidden flex-shrink-0">
                                <form id="mobile-send-message-form" class="flex space-x-2">
                                    <input type="file" id="mobile-image-input" accept="image/*" class="hidden">
                                    <button type="button" id="mobile-attach-btn" class="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <input type="text" id="mobile-message-input" placeholder="Type your message..." 
                                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent">
                                    <button type="submit" class="bg-uni-blue text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PROFILE PAGE -->
            <div id="profile-page" class="page">
                <div class="max-w-4xl mx-auto px-4 py-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                        <div class="gradient-bg h-32"></div>
                        <div class="px-6 pb-6">
                            <div class="flex items-end -mt-16 mb-4">
                                <div id="profile-avatar" class="w-24 h-24 bg-gradient-to-r from-uni-pink to-uni-purple rounded-full flex items-center justify-center text-white font-bold text-2xl border-4 border-white">
                                    U
                                </div>
                                <div class="ml-4 mb-2">
                                    <button id="edit-profile-btn" class="bg-uni-blue text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                        Edit Profile
                                    </button>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h1 id="profile-name" class="text-2xl font-bold text-gray-800 mb-2">Loading...</h1>
                                    <p id="profile-faculty" class="text-gray-600 mb-1">Student</p>
                                    <p id="profile-year" class="text-sm text-gray-500 mb-4">Year of Study</p>
                                    <p id="profile-bio" class="text-gray-700 mb-4">Loading profile...</p>
                                    
                                    <div class="mb-4">
                                        <h3 class="font-semibold text-gray-800 mb-2">Contact Info</h3>
                                        <p id="profile-email" class="text-sm text-gray-600 mb-1"><i class="fas fa-envelope mr-2"></i>Loading...</p>
                                        <p id="profile-phone" class="text-sm text-gray-600"><i class="fas fa-phone mr-2"></i>Not provided</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <div class="mb-4">
                                        <h3 class="font-semibold text-gray-800 mb-2">Skills I Offer</h3>
                                        <div id="profile-skills" class="flex flex-wrap gap-2">
                                            <span class="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-sm">Loading...</span>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <h3 class="font-semibold text-gray-800 mb-2">Stats</h3>
                                        <div class="grid grid-cols-2 gap-4 text-center">
                                            <div class="bg-gray-50 p-3 rounded-lg">
                                                <div id="profile-posts-count" class="text-xl font-bold text-uni-blue">0</div>
                                                <div class="text-sm text-gray-600">Posts</div>
                                            </div>
                                            <div class="bg-gray-50 p-3 rounded-lg">
                                                <div id="profile-connections-count" class="text-xl font-bold text-green-600">0</div>
                                                <div class="text-sm text-gray-600">Connections</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DASHBOARD PAGE -->
            <div id="dashboard-page" class="page">
                <div class="max-w-6xl mx-auto px-4 py-6">
                    <div class="mb-6">
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">Dashboard</h1>
                        <p class="text-gray-600">Your UniBuddy activity overview</p>
                    </div>

                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-uni-blue rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file-alt text-white text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p id="dashboard-posts" class="text-2xl font-bold text-gray-800">0</p>
                                    <p class="text-sm text-gray-600">Total Posts</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-handshake text-white text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p id="dashboard-connections" class="text-2xl font-bold text-gray-800">0</p>
                                    <p class="text-sm text-gray-600">Connections</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-yellow-500 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-eye text-white text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p id="dashboard-views" class="text-2xl font-bold text-gray-800">0</p>
                                    <p class="text-sm text-gray-600">Profile Views</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-purple-600 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-trophy text-white text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p id="dashboard-points" class="text-2xl font-bold text-gray-800">0</p>
                                    <p class="text-sm text-gray-600">Help Points</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Recent Activity -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                            <h3 class="font-semibold text-gray-800 mb-4">Recent Activity</h3>
                            <div id="recent-activity" class="space-y-4">
                                <div class="text-center py-4 text-gray-500">
                                    <i class="fas fa-clock text-2xl mb-2"></i>
                                    <p>No recent activity</p>
                                </div>
                            </div>
                        </div>

                        <!-- Your Skills -->
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100">
                            <h3 class="font-semibold text-gray-800 mb-4">Your Skills</h3>
                            <div id="dashboard-skills" class="space-y-3">
                                <div class="text-center py-4 text-gray-500">
                                    <i class="fas fa-tools text-2xl mb-2"></i>
                                    <p>Add skills to your profile</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div id="edit-post-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Edit Post</h3>
                <button id="close-edit-post-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="edit-post-form" class="space-y-4">
                <input type="hidden" id="edit-post-id">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Post Type</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-uni-blue transition-colors">
                            <input type="radio" name="edit-post-type" value="need" class="mr-3">
                            <div>
                                <div class="font-medium text-gray-800">Need Help</div>
                                <div class="text-sm text-gray-500">I need assistance with something</div>
                            </div>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-uni-blue transition-colors">
                            <input type="radio" name="edit-post-type" value="offer" class="mr-3">
                            <div>
                                <div class="font-medium text-gray-800">Offer Help</div>
                                <div class="text-sm text-gray-500">I can help others with something</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                    <input type="text" id="edit-post-title" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent"
                           placeholder="Brief description of what you need/offer">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="edit-post-description" rows="4" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent"
                              placeholder="Provide more details about your request or offer..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Skills/Tags</label>
                    <input type="text" id="edit-post-skills" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent"
                           placeholder="e.g., Python, Web Design, Mathematics (separate with commas)">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">What I can offer in return</label>
                    <textarea id="edit-post-exchange" rows="2"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent"
                              placeholder="What skills or help can you provide in exchange?"></textarea>
                </div>

                <button type="submit" class="w-full bg-uni-blue text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    Update Post
                </button>
            </form>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center">
        <div class="relative max-w-4xl max-h-[90vh] mx-4">
            <button id="close-image-modal" class="absolute -top-10 right-0 text-white hover:text-gray-300 text-2xl">
                <i class="fas fa-times"></i>
            </button>
            <img id="modal-image" src="" alt="Full size image" class="max-w-full max-h-full object-contain rounded-lg">
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Edit Profile</h3>
                <button id="close-edit-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="edit-profile-form" class="space-y-4">
                <!-- Profile Image Upload -->
                <div class="text-center">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Profile Picture</label>
                    <div class="relative inline-block">
                        <div id="edit-profile-preview" class="w-24 h-24 bg-gradient-to-r from-uni-pink to-uni-purple rounded-full flex items-center justify-center text-white font-bold text-2xl border-4 border-gray-200 cursor-pointer hover:border-uni-blue transition-colors">
                            U
                        </div>
                        <input type="file" id="profile-image-input" accept="image/*" class="hidden">
                        <button type="button" id="upload-image-btn" class="absolute -bottom-2 -right-2 w-8 h-8 bg-uni-blue text-white rounded-full hover:bg-blue-700 transition-colors flex items-center justify-center">
                            <i class="fas fa-camera text-sm"></i>
                        </button>
                        <button type="button" id="remove-image-btn" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors items-center justify-center text-xs hidden">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Click the camera icon to upload a photo</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                    <input type="text" id="edit-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Faculty/Major</label>
                    <input type="text" id="edit-faculty" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bio</label>
                    <textarea id="edit-bio" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent" placeholder="Tell others about yourself..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Skills (comma separated)</label>
                    <input type="text" id="edit-skills" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent" placeholder="JavaScript, Python, Design">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number (optional)</label>
                    <input type="tel" id="edit-phone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent" placeholder="+1 (555) 123-4567">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Year of Study</label>
                    <select id="edit-year" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uni-blue focus:border-transparent">
                        <option value="">Select Year</option>
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                        <option value="3rd Year">3rd Year</option>
                        <option value="4th Year">4th Year</option>
                        <option value="Graduate">Graduate</option>
                        <option value="PhD">PhD</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-uni-blue text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    Save Changes
                </button>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let allPosts = [];
        let userPosts = [];
        let currentChatId = null;
        let chatListeners = new Map();
        let messageListener = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            showLoading();
            initAuth();
            initNavigation();
            initForms();
            initResponsiveHandlers();
        });

        // Handle responsive behavior
        function initResponsiveHandlers() {
            // Handle window resize to switch between mobile and desktop views
            window.addEventListener('resize', () => {
                const isMobile = window.innerWidth < 1024;
                
                if (currentChatId) {
                    // If a chat is open, adjust the view based on screen size
                    if (isMobile) {
                        // Switch to mobile chat view if not already
                        if (!document.getElementById('mobile-chat-panel').classList.contains('flex')) {
                            // Get current conversation data and switch to mobile view
                            const chatUserName = document.getElementById('chat-user-name').textContent;
                            const chatUserFaculty = document.getElementById('chat-user-faculty').textContent;
                            const conversationData = {
                                partnerName: chatUserName,
                                partnerFaculty: chatUserFaculty
                            };
                            const initials = chatUserName ? chatUserName.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
                            showMobileChatView(conversationData, initials);
                        }
                    } else {
                        // Switch to desktop view if not already
                        if (document.getElementById('mobile-chat-panel').classList.contains('flex')) {
                            showMobileConversationsList();
                            // Re-open chat in desktop view
                            setTimeout(() => {
                                if (currentChatId) {
                                    openChat(currentChatId);
                                }
                            }, 100);
                        }
                    }
                } else if (isMobile) {
                    // Ensure mobile conversations view is shown when no chat is open
                    showMobileConversationsList();
                }
            });
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('show');
        }

        function showAuthContainer() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('main-app').classList.remove('show');
        }

        function showMainApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-app').classList.add('show');
        }

        // Authentication functions
        function initAuth() {
            // Auth state listener
            window.firebaseAuth.onAuthStateChanged(window.firebase.auth, (user) => {
                hideLoading();
                if (user) {
                    currentUser = user;
                    showMainApp();
                    loadUserProfile();
                    loadAllPosts();
                } else {
                    currentUser = null;
                    showAuthContainer();
                }
            });

            // Form toggle handlers
            document.getElementById('show-signup').addEventListener('click', () => {
                document.getElementById('signin-form').classList.add('hidden');
                document.getElementById('signup-form').classList.remove('hidden');
            });

            document.getElementById('show-signin').addEventListener('click', () => {
                document.getElementById('signup-form').classList.add('hidden');
                document.getElementById('signin-form').classList.remove('hidden');
            });

            // Sign in form
            document.getElementById('signin-form-element').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();
                
                const email = document.getElementById('signin-email').value;
                const password = document.getElementById('signin-password').value;
                
                try {
                    await window.firebaseAuth.signInWithEmailAndPassword(window.firebase.auth, email, password);
                } catch (error) {
                    hideLoading();
                    showError('signin-error', getErrorMessage(error.code));
                }
            });

            // Sign up form
            document.getElementById('signup-form-element').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();
                
                const name = document.getElementById('signup-name').value;
                const email = document.getElementById('signup-email').value;
                const faculty = document.getElementById('signup-faculty').value;
                const password = document.getElementById('signup-password').value;
                const confirmPassword = document.getElementById('signup-confirm-password').value;
                
                if (password !== confirmPassword) {
                    hideLoading();
                    showError('signup-error', 'Passwords do not match');
                    return;
                }
                
                try {
                    const userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(window.firebase.auth, email, password);
                    
                    // Create user profile in Firestore
                    await window.firebaseFirestore.setDoc(window.firebaseFirestore.doc(window.firebase.db, 'users', userCredential.user.uid), {
                        name: name,
                        email: email,
                        faculty: faculty,
                        bio: '',
                        skills: [],
                        connections: 0,
                        profileViews: 0,
                        helpPoints: 0,
                        createdAt: window.firebaseFirestore.serverTimestamp()
                    });
                } catch (error) {
                    hideLoading();
                    showError('signup-error', getErrorMessage(error.code));
                }
            });

            // Logout handler
            document.getElementById('logout-btn').addEventListener('click', async () => {
                try {
                    await window.firebaseAuth.signOut(window.firebase.auth);
                } catch (error) {
                    console.error('Logout error:', error);
                }
            });
        }

        function getErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return 'No account found with this email address.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again.';
                case 'auth/email-already-in-use':
                    return 'An account with this email already exists.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters long.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                default:
                    return 'An error occurred. Please try again.';
            }
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        // User profile functions
        async function loadUserProfile() {
            try {
                const userDoc = await window.firebaseFirestore.getDoc(window.firebaseFirestore.doc(window.firebase.db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    updateUserUI(userData);
                } else {
                    // Create default profile if doesn't exist
                    const defaultData = {
                        name: currentUser.email.split('@')[0],
                        email: currentUser.email,
                        faculty: 'Student',
                        bio: '',
                        skills: [],
                        connections: 0,
                        profileViews: 0,
                        helpPoints: 0
                    };
                    await window.firebaseFirestore.setDoc(window.firebaseFirestore.doc(window.firebase.db, 'users', currentUser.uid), defaultData);
                    updateUserUI(defaultData);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        function updateUserUI(userData) {
            // Update navigation user info
            const initials = userData.name.split(' ').map(n => n[0]).join('').toUpperCase();
            const userAvatar = document.getElementById('user-avatar');
            const profileAvatar = document.getElementById('profile-avatar');
            
            if (userData.profileImage) {
                userAvatar.style.backgroundImage = `url(${userData.profileImage})`;
                userAvatar.style.backgroundSize = 'cover';
                userAvatar.style.backgroundPosition = 'center';
                userAvatar.textContent = '';
                
                profileAvatar.style.backgroundImage = `url(${userData.profileImage})`;
                profileAvatar.style.backgroundSize = 'cover';
                profileAvatar.style.backgroundPosition = 'center';
                profileAvatar.textContent = '';
            } else {
                userAvatar.style.backgroundImage = '';
                userAvatar.textContent = initials;
                profileAvatar.style.backgroundImage = '';
                profileAvatar.textContent = initials;
            }
            
            document.getElementById('user-name').textContent = userData.name;
            document.getElementById('user-faculty').textContent = userData.faculty;

            // Update profile page
            document.getElementById('profile-name').textContent = userData.name;
            document.getElementById('profile-faculty').textContent = userData.faculty;
            document.getElementById('profile-year').textContent = userData.yearOfStudy || 'Year not specified';
            document.getElementById('profile-bio').textContent = userData.bio || 'No bio available';
            document.getElementById('profile-email').innerHTML = `<i class="fas fa-envelope mr-2"></i>${userData.email}`;
            document.getElementById('profile-phone').innerHTML = `<i class="fas fa-phone mr-2"></i>${userData.phone || 'Not provided'}`;
            
            // Update skills
            const skillsContainer = document.getElementById('profile-skills');
            if (userData.skills && userData.skills.length > 0) {
                skillsContainer.innerHTML = userData.skills.map(skill => 
                    `<span class="skill-tag text-white px-3 py-1 rounded-full text-sm">${skill}</span>`
                ).join('');
            } else {
                skillsContainer.innerHTML = '<span class="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-sm">No skills added</span>';
            }

            // Update stats
            document.getElementById('profile-posts-count').textContent = userData.postsCount || 0;
            document.getElementById('profile-connections-count').textContent = userData.connections || 0;
            document.getElementById('dashboard-posts').textContent = userData.postsCount || 0;
            document.getElementById('dashboard-connections').textContent = userData.connections || 0;
            document.getElementById('dashboard-views').textContent = userData.profileViews || 0;
            document.getElementById('dashboard-points').textContent = userData.helpPoints || 0;
        }

        // Image handling functions
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function resizeImage(file, maxWidth = 300, maxHeight = 300, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // Calculate new dimensions
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Posts functions
        async function loadAllPosts() {
            try {
                const postsQuery = window.firebaseFirestore.query(
                    window.firebaseFirestore.collection(window.firebase.db, 'posts'),
                    window.firebaseFirestore.orderBy('createdAt', 'desc')
                );
                const querySnapshot = await window.firebaseFirestore.getDocs(postsQuery);
                
                allPosts = [];
                querySnapshot.forEach((doc) => {
                    allPosts.push({ id: doc.id, ...doc.data() });
                });
                
                displayPosts(allPosts);
            } catch (error) {
                console.error('Error loading posts:', error);
                // Show demo posts if Firebase fails
                loadDemoPosts();
            }
        }

        function loadDemoPosts() {
            allPosts = [
                {
                    id: '1',
                    type: 'need',
                    title: 'Need help with React.js project',
                    description: 'I\'m working on a React project for my web development class and struggling with state management. Looking for someone who can help me understand hooks better.',
                    tags: ['React', 'JavaScript', 'Web Development'],
                    exchange: 'I can help with Python programming or data analysis',
                    author: 'Sarah Johnson',
                    authorFaculty: 'Computer Science',
                    authorInitials: 'SJ',
                    userId: 'user1',
                    createdAt: new Date(Date.now() - 2 * 60 * 60 * 1000),
                    likes: 5,
                    comments: 2
                },
                {
                    id: '2',
                    type: 'offer',
                    title: 'Offering tutoring in Mathematics',
                    description: 'I\'m a Mathematics major with experience in calculus, linear algebra, and statistics. Happy to help fellow students with their math courses.',
                    tags: ['Mathematics', 'Calculus', 'Statistics'],
                    exchange: 'Looking for help with graphic design or UI/UX',
                    author: 'Mike Chen',
                    authorFaculty: 'Mathematics',
                    authorInitials: 'MC',
                    userId: 'user2',
                    createdAt: new Date(Date.now() - 5 * 60 * 60 * 1000),
                    likes: 8,
                    comments: 4
                }
            ];
            displayPosts(allPosts);
        }

        function displayPosts(posts) {
            const container = document.getElementById('posts-container');
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">No posts found</h3>
                        <p class="text-gray-500">Be the first to create a post!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            posts.forEach(post => {
                const postElement = createPostElement(post);
                container.appendChild(postElement);
            });
        }

        function createPostElement(post) {
            const postDiv = document.createElement('div');
            postDiv.className = 'bg-white rounded-xl shadow-sm border border-gray-100 post-card';
            
            const typeClass = post.type === 'need' ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600';
            const typeText = post.type === 'need' ? 'Need Help' : 'Offering Help';
            const exchangeClass = post.type === 'need' ? 'bg-green-50 text-green-700' : 'bg-blue-50 text-blue-700';
            const exchangeLabel = post.type === 'need' ? 'Offering in return:' : 'Looking for in return:';
            
            const timeAgo = post.createdAt ? getTimeAgo(post.createdAt.toDate ? post.createdAt.toDate() : post.createdAt) : 'Just now';
            
            postDiv.innerHTML = `
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-semibold overflow-hidden" style="${post.authorImage ? `background-image: url(${post.authorImage}); background-size: cover; background-position: center;` : ''}">
                            ${post.authorImage ? '' : (post.authorInitials || post.author?.charAt(0) || 'U')}
                        </div>
                        <div class="ml-3">
                            <h3 class="font-semibold text-gray-800">${post.author || 'Anonymous'}</h3>
                            <p class="text-sm text-gray-500">${post.authorFaculty || 'Student'} • ${timeAgo}</p>
                        </div>
                        <div class="ml-auto">
                            <span class="${typeClass} px-3 py-1 rounded-full text-sm font-medium">${typeText}</span>
                        </div>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">${post.title}</h4>
                    <p class="text-gray-600 mb-4">${post.description}</p>
                    
                    ${post.tags && post.tags.length > 0 ? `
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${post.tags.map(tag => `<span class="skill-tag text-white px-3 py-1 rounded-full text-sm">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    ${post.exchange ? `
                        <div class="${exchangeClass} p-3 rounded-lg mb-4">
                            <p class="text-sm"><strong>${exchangeLabel}</strong> ${post.exchange}</p>
                        </div>
                    ` : ''}
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <button class="like-btn flex items-center text-gray-500 hover:text-red-500 transition-colors">
                                <i class="far fa-heart mr-2"></i>
                                <span>${post.likes || 0}</span>
                            </button>
                            <button class="flex items-center text-gray-500 hover:text-uni-blue transition-colors">
                                <i class="fas fa-comment mr-2"></i>
                                <span>${post.comments || 0}</span>
                            </button>
                        </div>
                        ${post.userId !== currentUser?.uid ? `
                            <button class="connect-btn ${post.type === 'need' ? 'bg-uni-blue hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'} text-white px-6 py-2 rounded-lg transition-colors">
                                ${post.type === 'need' ? 'Help Out' : 'Connect'}
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Add event listeners
            const likeBtn = postDiv.querySelector('.like-btn');
            if (likeBtn) {
                likeBtn.addEventListener('click', function() {
                    const icon = this.querySelector('i');
                    const count = this.querySelector('span');
                    
                    if (icon.classList.contains('far')) {
                        icon.classList.remove('far');
                        icon.classList.add('fas', 'text-red-500');
                        count.textContent = parseInt(count.textContent) + 1;
                    } else {
                        icon.classList.remove('fas', 'text-red-500');
                        icon.classList.add('far');
                        count.textContent = parseInt(count.textContent) - 1;
                    }
                });
            }
            
            const connectBtn = postDiv.querySelector('.connect-btn');
            if (connectBtn) {
                connectBtn.addEventListener('click', async function() {
                    const originalText = this.textContent;
                    this.textContent = 'Connecting...';
                    this.disabled = true;
                    
                    try {
                        // Start a chat with the post author
                        const partnerId = await startChat(post.userId);
                        if (partnerId) {
                            // Switch to messages page and open the chat
                            showPage('messages');
                            setTimeout(() => openChat(partnerId), 500);
                            
                            this.textContent = 'Chat Started!';
                            this.className = 'connect-btn bg-green-500 text-white px-6 py-2 rounded-lg';
                        } else {
                            throw new Error('Failed to start chat');
                        }
                    } catch (error) {
                        console.error('Error starting chat:', error);
                        this.textContent = 'Try Again';
                        this.className = `connect-btn ${post.type === 'need' ? 'bg-uni-blue hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'} text-white px-6 py-2 rounded-lg transition-colors`;
                        this.disabled = false;
                    }
                });
            }
            
            return postDiv;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        // Messenger-style Chat System Functions
        async function startChat(otherUserId) {
            if (!currentUser || otherUserId === currentUser.uid) return null;
            
            try {
                // Check if conversation already exists in current user's conversations
                const existingConversation = await findExistingConversation(otherUserId);
                if (existingConversation) {
                    return otherUserId; // Return the partner's ID as the conversation identifier
                }
                
                // Create conversation entry for both users
                await createConversationForBothUsers(otherUserId);
                
                return otherUserId;
            } catch (error) {
                console.error('Error starting conversation:', error);
                return null;
            }
        }

        async function findExistingConversation(otherUserId) {
            try {
                const conversationDoc = await window.firebaseFirestore.getDoc(
                    window.firebaseFirestore.doc(window.firebase.db, 'users', currentUser.uid, 'conversations', otherUserId)
                );
                
                return conversationDoc.exists();
            } catch (error) {
                console.error('Error finding existing conversation:', error);
                return false;
            }
        }

        async function createConversationForBothUsers(otherUserId) {
            try {
                // Get other user's info
                const otherUserDoc = await window.firebaseFirestore.getDoc(
                    window.firebaseFirestore.doc(window.firebase.db, 'users', otherUserId)
                );
                const currentUserDoc = await window.firebaseFirestore.getDoc(
                    window.firebaseFirestore.doc(window.firebase.db, 'users', currentUser.uid)
                );
                
                const otherUserData = otherUserDoc.data();
                const currentUserData = currentUserDoc.data();
                
                const timestamp = window.firebaseFirestore.serverTimestamp();
                
                // Create conversation entry in current user's conversations
                await window.firebaseFirestore.setDoc(
                    window.firebaseFirestore.doc(window.firebase.db, 'users', currentUser.uid, 'conversations', otherUserId),
                    {
                        partnerId: otherUserId,
                        partnerName: otherUserData.name,
                        partnerFaculty: otherUserData.faculty,
                        partnerImage: otherUserData.profileImage || null,
                        lastMessage: '',
                        lastUpdated: timestamp,
                        createdAt: timestamp,
                        unreadCount: 0
                    }
                );
                
                // Create conversation entry in other user's conversations
                await window.firebaseFirestore.setDoc(
                    window.firebaseFirestore.doc(window.firebase.db, 'users', otherUserId, 'conversations', currentUser.uid),
                    {
                        partnerId: currentUser.uid,
                        partnerName: currentUserData.name,
                        partnerFaculty: currentUserData.faculty,
                        partnerImage: currentUserData.profileImage || null,
                        lastMessage: '',
                        lastUpdated: timestamp,
                        createdAt: timestamp,
                        unreadCount: 0
                    }
                );
            } catch (error) {
                console.error('Error creating conversation for both users:', error);
            }
        }

        async function loadChatList() {
            if (!currentUser) return;
            
            try {
                // Query all conversations from current user's conversations subcollection (Inbox View)
                const conversationsQuery = window.firebaseFirestore.query(
                    window.firebaseFirestore.collection(window.firebase.db, 'users', currentUser.uid, 'conversations'),
                    window.firebaseFirestore.orderBy('lastUpdated', 'desc')
                );
                
                // Clean up existing listeners
                chatListeners.forEach(unsubscribe => unsubscribe());
                chatListeners.clear();
                
                const unsubscribe = window.firebaseFirestore.onSnapshot(conversationsQuery, (snapshot) => {
                    const chatList = document.getElementById('chat-list');
                    
                    if (snapshot.empty) {
                        chatList.innerHTML = `
                            <div class="p-4 text-center text-gray-500">
                                <i class="fas fa-comments text-2xl mb-2"></i>
                                <p class="text-sm">No conversations yet</p>
                                <p class="text-xs mt-1">Connect with someone from a post to start chatting!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    chatList.innerHTML = '';
                    
                    snapshot.forEach((doc) => {
                        const conversationData = doc.data();
                        const chatItem = createChatListItem(conversationData.partnerId, conversationData, conversationData);
                        chatList.appendChild(chatItem);
                    });
                });
                
                chatListeners.set('main', unsubscribe);
            } catch (error) {
                console.error('Error loading conversation list:', error);
            }
        }

        function createChatListItem(partnerId, conversationData, chatData) {
            const chatItem = document.createElement('div');
            chatItem.className = 'p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors';
            chatItem.setAttribute('data-chat-id', partnerId);
            
            const initials = conversationData.partnerName ? conversationData.partnerName.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
            const lastMessageTime = chatData.lastUpdated ? getTimeAgo(chatData.lastUpdated.toDate()) : '';
            const unreadBadge = chatData.unreadCount > 0 ? `<span class="bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center ml-2">${chatData.unreadCount}</span>` : '';
            
            chatItem.innerHTML = `
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-r from-uni-pink to-uni-purple rounded-full flex items-center justify-center text-white font-semibold overflow-hidden" style="${conversationData.partnerImage ? `background-image: url(${conversationData.partnerImage}); background-size: cover; background-position: center;` : ''}">
                        ${conversationData.partnerImage ? '' : initials}
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h4 class="font-semibold text-gray-800 truncate">${conversationData.partnerName}</h4>
                            <div class="flex items-center">
                                <span class="text-xs text-gray-500">${lastMessageTime}</span>
                                ${unreadBadge}
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 truncate">${chatData.lastMessage || 'Start a conversation...'}</p>
                        <p class="text-xs text-gray-400">${conversationData.partnerFaculty}</p>
                    </div>
                </div>
            `;
            
            chatItem.addEventListener('click', () => openChat(partnerId));
            
            return chatItem;
        }

        async function openChat(partnerId) {
            currentChatId = partnerId;
            
            try {
                // Get conversation data from current user's conversations
                const conversationDoc = await window.firebaseFirestore.getDoc(
                    window.firebaseFirestore.doc(window.firebase.db, 'users', currentUser.uid, 'conversations', partnerId)
                );
                
                if (!conversationDoc.exists()) return;
                
                const conversationData = conversationDoc.data();
                const initials = conversationData.partnerName ? conversationData.partnerName.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
                
                // Check if mobile view
                const isMobile = window.innerWidth < 1024; // lg breakpoint
                
                if (isMobile) {
                    // Mobile: Switch to chat view
                    showMobileChatView(conversationData, initials);
                } else {
                    // Desktop: Update desktop chat panel
                    showDesktopChatView(conversationData, initials);
                }
                
                // Load messages from current user's conversation with this partner
                loadChatMessages(partnerId);
                
                // Mark messages as read
                await markMessagesAsRead(partnerId);
                
                // Update active chat in list
                document.querySelectorAll('[data-chat-id]').forEach(item => {
                    item.classList.remove('bg-uni-blue', 'text-white');
                    item.classList.add('hover:bg-gray-50');
                });
                
                const activeItem = document.querySelector(`[data-chat-id="${partnerId}"]`);
                if (activeItem) {
                    activeItem.classList.add('bg-uni-blue', 'text-white');
                    activeItem.classList.remove('hover:bg-gray-50');
                }
            } catch (error) {
                console.error('Error opening conversation:', error);
            }
        }

        function showMobileChatView(conversationData, initials) {
            // Hide conversations panel and header
            document.getElementById('conversations-panel').classList.add('hidden');
            document.getElementById('mobile-conversations-header').classList.add('hidden');
            
            // Show mobile chat panel and header
            document.getElementById('mobile-chat-panel').classList.remove('hidden');
            document.getElementById('mobile-chat-panel').classList.add('flex');
            document.getElementById('mobile-chat-header').classList.remove('hidden');
            document.getElementById('mobile-chat-input-container').classList.remove('hidden');
            
            // Update mobile chat header
            const mobileAvatar = document.getElementById('mobile-chat-user-avatar');
            if (conversationData.partnerImage) {
                mobileAvatar.style.backgroundImage = `url(${conversationData.partnerImage})`;
                mobileAvatar.style.backgroundSize = 'cover';
                mobileAvatar.style.backgroundPosition = 'center';
                mobileAvatar.textContent = '';
            } else {
                mobileAvatar.style.backgroundImage = '';
                mobileAvatar.textContent = initials;
            }
            
            document.getElementById('mobile-chat-user-name').textContent = conversationData.partnerName;
            document.getElementById('mobile-chat-user-faculty').textContent = conversationData.partnerFaculty;
        }

        function showDesktopChatView(conversationData, initials) {
            // Update desktop chat header
            const chatHeader = document.getElementById('chat-header');
            const chatUserAvatar = document.getElementById('chat-user-avatar');
            
            if (conversationData.partnerImage) {
                chatUserAvatar.style.backgroundImage = `url(${conversationData.partnerImage})`;
                chatUserAvatar.style.backgroundSize = 'cover';
                chatUserAvatar.style.backgroundPosition = 'center';
                chatUserAvatar.textContent = '';
            } else {
                chatUserAvatar.style.backgroundImage = '';
                chatUserAvatar.textContent = initials;
            }
            
            document.getElementById('chat-user-name').textContent = conversationData.partnerName;
            document.getElementById('chat-user-faculty').textContent = conversationData.partnerFaculty;
            
            chatHeader.classList.remove('hidden');
            document.getElementById('chat-input-container').classList.remove('hidden');
        }

        function showMobileConversationsList() {
            // Hide mobile chat panel and header
            document.getElementById('mobile-chat-panel').classList.add('hidden');
            document.getElementById('mobile-chat-panel').classList.remove('flex');
            document.getElementById('mobile-chat-header').classList.add('hidden');
            document.getElementById('mobile-chat-input-container').classList.add('hidden');
            
            // Show conversations panel and header
            document.getElementById('conversations-panel').classList.remove('hidden');
            document.getElementById('mobile-conversations-header').classList.remove('hidden');
            
            // Clear current chat
            currentChatId = null;
            
            // Clean up message listener
            if (messageListener) {
                messageListener();
                messageListener = null;
            }
        }

        async function markMessagesAsRead(partnerId) {
            try {
                // Reset unread count for this conversation
                await window.firebaseFirestore.updateDoc(
                    window.firebaseFirestore.doc(window.firebase.db, 'users', currentUser.uid, 'conversations', partnerId),
                    {
                        unreadCount: 0
                    }
                );
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }
        }

        function loadChatMessages(partnerId) {
            // Clean up existing message listener
            if (messageListener) {
                messageListener();
                messageListener = null;
            }
            
            try {
                // Query messages from current user's conversation path: users/{currentUserId}/conversations/{partnerId}/messages
                const messagesQuery = window.firebaseFirestore.query(
                    window.firebaseFirestore.collection(window.firebase.db, 'users', currentUser.uid, 'conversations', partnerId, 'messages'),
                    window.firebaseFirestore.orderBy('timestamp', 'asc')
                );
                
                messageListener = window.firebaseFirestore.onSnapshot(messagesQuery, (snapshot) => {
                    // Determine which messages container to use based on screen size
                    const isMobile = window.innerWidth < 1024;
                    const messagesContainer = isMobile ? 
                        document.getElementById('mobile-chat-messages') : 
                        document.getElementById('chat-messages');
                    
                    messagesContainer.innerHTML = '';
                    
                    if (snapshot.empty) {
                        messagesContainer.innerHTML = `
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-comment text-2xl mb-2"></i>
                                <p>No messages yet. Start the conversation!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Process all messages with proper left-right alignment based on senderId
                    snapshot.forEach((doc) => {
                        const messageData = doc.data();
                        const messageElement = createMessageElement(messageData);
                        messagesContainer.appendChild(messageElement);
                    });
                    
                    // Scroll to bottom to show latest messages
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 100);
                });
            } catch (error) {
                console.error('Error loading messages:', error);
                // Show fallback message if Firebase fails
                const isMobile = window.innerWidth < 1024;
                const messagesContainer = isMobile ? 
                    document.getElementById('mobile-chat-messages') : 
                    document.getElementById('chat-messages');
                    
                messagesContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Unable to load messages. Please try again.</p>
                    </div>
                `;
            }
        }

        function createMessageElement(messageData) {
            const messageDiv = document.createElement('div');
            const isOwnMessage = messageData.senderId === currentUser.uid;
            
            // Handle timestamp - check if it's a Unix timestamp (number) or Firestore timestamp
            let timestamp = 'Sending...';
            if (messageData.timestamp) {
                if (typeof messageData.timestamp === 'number') {
                    // Unix timestamp in milliseconds
                    timestamp = getTimeAgo(new Date(messageData.timestamp));
                } else if (messageData.timestamp.toDate) {
                    // Firestore timestamp
                    timestamp = getTimeAgo(messageData.timestamp.toDate());
                }
            }
            
            // Facebook-style alignment: sent messages on right (blue), received on left (gray)
            messageDiv.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'} chat-message mb-4`;
            
            // Create message content based on whether it has image or text
            let messageContent = '';
            
            if (messageData.imageUrl) {
                messageContent = `
                    <div class="${isOwnMessage ? 'bg-uni-blue text-white ml-auto' : 'bg-gray-200 text-gray-800 mr-auto'} rounded-lg p-2 inline-block">
                        <img src="${messageData.imageUrl}" alt="Shared image" class="rounded-md max-w-[300px] max-h-[300px] object-cover cursor-pointer" onclick="openImageModal('${messageData.imageUrl}')">
                        ${messageData.text ? `<p class="text-sm break-words mt-2">${messageData.text}</p>` : ''}
                    </div>
                `;
            } else {
                messageContent = `
                    <div class="${isOwnMessage ? 'bg-uni-blue text-white ml-auto' : 'bg-gray-200 text-gray-800 mr-auto'} rounded-lg px-4 py-2 inline-block">
                        <p class="text-sm break-words">${messageData.text}</p>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md ${isOwnMessage ? 'text-right' : 'text-left'}">
                    ${messageContent}
                    <p class="text-xs text-gray-500 mt-1 ${isOwnMessage ? 'text-right' : 'text-left'}">${timestamp}</p>
                </div>
            `;
            
            return messageDiv;
        }

        async function sendMessage(partnerId, messageText, imageUrl = null) {
            if ((!messageText.trim() && !imageUrl) || !currentUser) return false;
            
            try {
                // Use Unix timestamp in milliseconds for consistent sorting
                const timestamp = Date.now();
                const messageData = {
                    senderId: currentUser.uid,
                    receiverId: partnerId,
                    text: messageText.trim(),
                    timestamp: timestamp,
                    seen: false
                };
                
                // Add image URL if provided
                if (imageUrl) {
                    messageData.imageUrl = imageUrl;
                }
                
                // Save message to sender's conversation path: users/{senderId}/conversations/{receiverId}/messages
                await window.firebaseFirestore.addDoc(
                    window.firebaseFirestore.collection(window.firebase.db, 'users', currentUser.uid, 'conversations', partnerId, 'messages'),
                    messageData
                );
                
                // Save message to receiver's conversation path: users/{receiverId}/conversations/{senderId}/messages
                await window.firebaseFirestore.addDoc(
                    window.firebaseFirestore.collection(window.firebase.db, 'users', partnerId, 'conversations', currentUser.uid, 'messages'),
                    messageData
                );
                
                // Determine last message preview
                const lastMessagePreview = imageUrl ? (messageText.trim() ? `📷 ${messageText.trim()}` : '📷 Image') : messageText.trim();
                
                // Update last message in sender's conversation
                await window.firebaseFirestore.updateDoc(
                    window.firebaseFirestore.doc(window.firebase.db, 'users', currentUser.uid, 'conversations', partnerId),
                    {
                        lastMessage: lastMessagePreview,
                        lastUpdated: window.firebaseFirestore.serverTimestamp()
                    }
                );
                
                // Update last message in receiver's conversation and increment unread count
                const receiverConversationRef = window.firebaseFirestore.doc(window.firebase.db, 'users', partnerId, 'conversations', currentUser.uid);
                const receiverConversationDoc = await window.firebaseFirestore.getDoc(receiverConversationRef);
                
                if (receiverConversationDoc.exists()) {
                    const currentUnreadCount = receiverConversationDoc.data().unreadCount || 0;
                    await window.firebaseFirestore.updateDoc(receiverConversationRef, {
                        lastMessage: lastMessagePreview,
                        lastUpdated: window.firebaseFirestore.serverTimestamp(),
                        unreadCount: currentUnreadCount + 1
                    });
                }
                
                return true;
            } catch (error) {
                console.error('Error sending message:', error);
                return false;
            }
        }

        async function uploadImageToFirebase(file) {
            try {
                // Create a unique filename
                const timestamp = Date.now();
                const fileName = `chat-images/${currentUser.uid}_${timestamp}_${file.name}`;
                
                // Create storage reference
                const storageRef = window.firebaseStorage.ref(window.firebase.storage, fileName);
                
                // Upload file
                await window.firebaseStorage.uploadBytes(storageRef, file);
                
                // Get download URL
                const downloadURL = await window.firebaseStorage.getDownloadURL(storageRef);
                
                return downloadURL;
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        // Image modal function
        function openImageModal(imageUrl) {
            document.getElementById('modal-image').src = imageUrl;
            document.getElementById('image-modal').classList.remove('hidden');
            document.getElementById('image-modal').classList.add('flex');
        }

        // Create post function
        async function createPost(postData) {
            try {
                const userDoc = await window.firebaseFirestore.getDoc(window.firebaseFirestore.doc(window.firebase.db, 'users', currentUser.uid));
                const userData = userDoc.data();
                
                const newPost = {
                    ...postData,
                    userId: currentUser.uid,
                    author: userData.name,
                    authorFaculty: userData.faculty,
                    authorInitials: userData.name.split(' ').map(n => n[0]).join('').toUpperCase(),
                    authorImage: userData.profileImage || null,
                    createdAt: window.firebaseFirestore.serverTimestamp(),
                    likes: 0,
                    comments: 0
                };
                
                await window.firebaseFirestore.addDoc(window.firebaseFirestore.collection(window.firebase.db, 'posts'), newPost);
                return true;
            } catch (error) {
                console.error('Error creating post:', error);
                return false;
            }
        }

        // Load user's posts
        async function loadMyPosts() {
            if (!currentUser) {
                displayMyPosts();
                return;
            }
            
            try {
                const postsQuery = window.firebaseFirestore.query(
                    window.firebaseFirestore.collection(window.firebase.db, 'posts'),
                    window.firebaseFirestore.where('userId', '==', currentUser.uid),
                    window.firebaseFirestore.orderBy('createdAt', 'desc')
                );
                const querySnapshot = await window.firebaseFirestore.getDocs(postsQuery);
                
                userPosts = [];
                querySnapshot.forEach((doc) => {
                    userPosts.push({ id: doc.id, ...doc.data() });
                });
                
                displayMyPosts();
            } catch (error) {
                console.error('Error loading user posts:', error);
                // Show empty state if Firebase fails
                userPosts = [];
                displayMyPosts();
            }
        }

        function displayMyPosts() {
            const container = document.getElementById('my-posts-container');
            
            if (userPosts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-plus-circle text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">No posts yet</h3>
                        <p class="text-gray-500">Create your first post to get started!</p>
                        <button data-page="create" class="nav-trigger mt-4 bg-uni-blue text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Create Post
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            userPosts.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'bg-white rounded-xl shadow-sm border border-gray-100 p-6';
                
                const typeClass = post.type === 'need' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600';
                const timeAgo = post.createdAt ? getTimeAgo(post.createdAt.toDate ? post.createdAt.toDate() : post.createdAt) : 'Just now';
                
                postDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center space-x-2">
                            <span class="${typeClass} px-3 py-1 rounded-full text-sm font-medium">${post.type === 'need' ? 'Need Help' : 'Offering Help'}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="edit-post-btn text-uni-blue hover:text-blue-700 text-sm font-medium" data-post-id="${post.id}">Edit</button>
                            <button class="delete-post-btn text-red-600 hover:text-red-700 text-sm font-medium" data-post-id="${post.id}">Delete</button>
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">${post.title}</h3>
                    <p class="text-gray-600 mb-4">${post.description}</p>
                    
                    ${post.tags && post.tags.length > 0 ? `
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${post.tags.map(tag => `<span class="skill-tag text-white px-3 py-1 rounded-full text-sm">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-between items-center text-sm text-gray-500">
                        <span>Created ${timeAgo}</span>
                        <div class="flex items-center space-x-4">
                            <span><i class="fas fa-heart mr-1"></i>${post.likes || 0}</span>
                            <span><i class="fas fa-comment mr-1"></i>${post.comments || 0}</span>
                        </div>
                    </div>
                `;
                
                // Add edit functionality
                const editBtn = postDiv.querySelector('.edit-post-btn');
                editBtn.addEventListener('click', () => {
                    openEditPostModal(post);
                });
                
                // Add delete functionality
                const deleteBtn = postDiv.querySelector('.delete-post-btn');
                deleteBtn.addEventListener('click', async () => {
                    if (confirm('Are you sure you want to delete this post?')) {
                        try {
                            await window.firebaseFirestore.deleteDoc(window.firebaseFirestore.doc(window.firebase.db, 'posts', post.id));
                            loadMyPosts();
                            loadAllPosts();
                        } catch (error) {
                            console.error('Error deleting post:', error);
                            alert('Error deleting post. Please try again.');
                        }
                    }
                });
                
                container.appendChild(postDiv);
            });
        }

        // Edit post functions
        function openEditPostModal(post) {
            document.getElementById('edit-post-id').value = post.id;
            document.getElementById('edit-post-title').value = post.title;
            document.getElementById('edit-post-description').value = post.description;
            document.getElementById('edit-post-skills').value = post.tags ? post.tags.join(', ') : '';
            document.getElementById('edit-post-exchange').value = post.exchange || '';
            
            // Set post type
            const typeRadio = document.querySelector(`input[name="edit-post-type"][value="${post.type}"]`);
            if (typeRadio) {
                typeRadio.checked = true;
            }
            
            document.getElementById('edit-post-modal').classList.remove('hidden');
            document.getElementById('edit-post-modal').classList.add('flex');
        }

        async function updatePost(postId, updatedData) {
            try {
                await window.firebaseFirestore.updateDoc(
                    window.firebaseFirestore.doc(window.firebase.db, 'posts', postId),
                    {
                        ...updatedData,
                        updatedAt: window.firebaseFirestore.serverTimestamp()
                    }
                );
                return true;
            } catch (error) {
                console.error('Error updating post:', error);
                return false;
            }
        }

        // Search functionality
        function performSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const tagsFilter = document.getElementById('tags-filter').value.toLowerCase();
            const sort = document.getElementById('sort-filter').value;
            
            let filteredPosts = allPosts.filter(post => {
                const matchesSearch = !searchTerm || 
                    post.title.toLowerCase().includes(searchTerm) ||
                    post.description.toLowerCase().includes(searchTerm) ||
                    (post.tags && post.tags.some(tag => tag.toLowerCase().includes(searchTerm)));
                
                const matchesCategory = !category || post.type === category;
                
                const matchesTags = !tagsFilter || 
                    (post.tags && post.tags.some(tag => tag.toLowerCase().includes(tagsFilter)));
                
                return matchesSearch && matchesCategory && matchesTags;
            });
            
            // Sort results
            if (sort === 'oldest') {
                filteredPosts.sort((a, b) => a.createdAt - b.createdAt);
            } else {
                filteredPosts.sort((a, b) => b.createdAt - a.createdAt);
            }
            
            const resultsContainer = document.getElementById('search-results');
            
            if (filteredPosts.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">No results found</h3>
                        <p class="text-gray-500">Try adjusting your search criteria</p>
                    </div>
                `;
            } else {
                resultsContainer.innerHTML = '';
                filteredPosts.forEach(post => {
                    const postElement = createPostElement(post);
                    resultsContainer.appendChild(postElement);
                });
            }
        }

        // Navigation functionality
        function initNavigation() {
            // Desktop navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetPage = this.getAttribute('data-page');
                    showPage(targetPage);
                    updateActiveNav(this);
                });
            });

            // Mobile navigation
            document.querySelectorAll('.mobile-nav').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetPage = this.getAttribute('data-page');
                    showPage(targetPage);
                    updateActiveMobileNav(this);
                });
            });

            // Navigation triggers
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('nav-trigger') || e.target.closest('.nav-trigger')) {
                    e.preventDefault();
                    const trigger = e.target.classList.contains('nav-trigger') ? e.target : e.target.closest('.nav-trigger');
                    const targetPage = trigger.getAttribute('data-page');
                    showPage(targetPage);
                }
            });
        }

        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show target page
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.classList.add('active');
                
                // Load page-specific content
                switch(pageId) {
                    case 'home':
                        loadAllPosts();
                        break;
                    case 'explore':
                        // Search functionality is already initialized
                        break;
                    case 'myposts':
                        loadMyPosts();
                        break;
                    case 'messages':
                        loadChatList();
                        break;
                    case 'profile':
                        loadUserProfile();
                        break;
                }
            }
        }

        function updateActiveNav(activeItem) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active', 'bg-gradient-to-r', 'from-uni-blue', 'to-uni-purple', 'text-white');
                item.classList.add('text-gray-600');
            });
            
            activeItem.classList.add('active', 'bg-gradient-to-r', 'from-uni-blue', 'to-uni-purple', 'text-white');
            activeItem.classList.remove('text-gray-600');
        }

        function updateActiveMobileNav(activeItem) {
            document.querySelectorAll('.mobile-nav').forEach(item => {
                item.classList.remove('text-uni-blue');
                item.classList.add('text-gray-500');
            });
            
            activeItem.classList.add('text-uni-blue');
            activeItem.classList.remove('text-gray-500');
        }

        // Form handling
        function initForms() {
            // Create post form
            document.getElementById('create-post-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();
                
                const formData = {
                    type: document.querySelector('input[name="post-type"]:checked').value,
                    title: document.getElementById('post-title').value,
                    description: document.getElementById('post-description').value,
                    tags: document.getElementById('post-skills').value.split(',').map(s => s.trim()).filter(s => s),
                    exchange: document.getElementById('post-exchange').value
                };
                
                const success = await createPost(formData);
                hideLoading();
                
                if (success) {
                    alert('Post created successfully!');
                    document.getElementById('create-post-form').reset();
                    showPage('home');
                    loadAllPosts();
                } else {
                    alert('Error creating post. Please try again.');
                }
            });

            // Profile image upload handlers
            let currentProfileImage = null;
            
            document.getElementById('upload-image-btn').addEventListener('click', () => {
                document.getElementById('profile-image-input').click();
            });
            
            document.getElementById('edit-profile-preview').addEventListener('click', () => {
                document.getElementById('profile-image-input').click();
            });
            
            document.getElementById('profile-image-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) { // 5MB limit
                        alert('Image size should be less than 5MB');
                        return;
                    }
                    
                    try {
                        showLoading();
                        const resizedImage = await resizeImage(file);
                        currentProfileImage = resizedImage;
                        
                        // Update preview
                        const preview = document.getElementById('edit-profile-preview');
                        preview.style.backgroundImage = `url(${resizedImage})`;
                        preview.style.backgroundSize = 'cover';
                        preview.style.backgroundPosition = 'center';
                        preview.textContent = '';
                        
                        // Show remove button
                        document.getElementById('remove-image-btn').classList.remove('hidden');
                        document.getElementById('remove-image-btn').classList.add('flex');
                        
                        hideLoading();
                    } catch (error) {
                        hideLoading();
                        console.error('Error processing image:', error);
                        alert('Error processing image. Please try again.');
                    }
                }
            });
            
            document.getElementById('remove-image-btn').addEventListener('click', () => {
                currentProfileImage = null;
                const preview = document.getElementById('edit-profile-preview');
                preview.style.backgroundImage = '';
                preview.textContent = 'U';
                document.getElementById('remove-image-btn').classList.add('hidden');
                document.getElementById('remove-image-btn').classList.remove('flex');
                document.getElementById('profile-image-input').value = '';
            });

            // Edit profile form
            document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();
                
                const updatedData = {
                    name: document.getElementById('edit-name').value,
                    faculty: document.getElementById('edit-faculty').value,
                    bio: document.getElementById('edit-bio').value,
                    skills: document.getElementById('edit-skills').value.split(',').map(s => s.trim()).filter(s => s),
                    phone: document.getElementById('edit-phone').value,
                    yearOfStudy: document.getElementById('edit-year').value
                };
                
                // Add profile image if uploaded
                if (currentProfileImage !== null) {
                    updatedData.profileImage = currentProfileImage;
                }
                
                try {
                    await window.firebaseFirestore.updateDoc(window.firebaseFirestore.doc(window.firebase.db, 'users', currentUser.uid), updatedData);
                    hideLoading();
                    document.getElementById('edit-profile-modal').classList.add('hidden');
                    document.getElementById('edit-profile-modal').classList.remove('flex');
                    loadUserProfile();
                    alert('Profile updated successfully!');
                } catch (error) {
                    hideLoading();
                    console.error('Error updating profile:', error);
                    alert('Error updating profile. Please try again.');
                }
            });

            // Edit post form
            document.getElementById('edit-post-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading();
                
                const postId = document.getElementById('edit-post-id').value;
                const updatedData = {
                    type: document.querySelector('input[name="edit-post-type"]:checked').value,
                    title: document.getElementById('edit-post-title').value,
                    description: document.getElementById('edit-post-description').value,
                    tags: document.getElementById('edit-post-skills').value.split(',').map(s => s.trim()).filter(s => s),
                    exchange: document.getElementById('edit-post-exchange').value
                };
                
                const success = await updatePost(postId, updatedData);
                hideLoading();
                
                if (success) {
                    document.getElementById('edit-post-modal').classList.add('hidden');
                    document.getElementById('edit-post-modal').classList.remove('flex');
                    loadMyPosts();
                    loadAllPosts();
                    alert('Post updated successfully!');
                } else {
                    alert('Error updating post. Please try again.');
                }
            });

            // Edit post modal close
            document.getElementById('close-edit-post-modal').addEventListener('click', () => {
                document.getElementById('edit-post-modal').classList.add('hidden');
                document.getElementById('edit-post-modal').classList.remove('flex');
            });

            // Edit profile modal
            document.getElementById('edit-profile-btn').addEventListener('click', async () => {
                try {
                    const userDoc = await window.firebaseFirestore.getDoc(window.firebaseFirestore.doc(window.firebase.db, 'users', currentUser.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        document.getElementById('edit-name').value = userData.name || '';
                        document.getElementById('edit-faculty').value = userData.faculty || '';
                        document.getElementById('edit-bio').value = userData.bio || '';
                        document.getElementById('edit-skills').value = userData.skills ? userData.skills.join(', ') : '';
                        document.getElementById('edit-phone').value = userData.phone || '';
                        document.getElementById('edit-year').value = userData.yearOfStudy || '';
                        
                        // Set profile image preview
                        const preview = document.getElementById('edit-profile-preview');
                        if (userData.profileImage) {
                            preview.style.backgroundImage = `url(${userData.profileImage})`;
                            preview.style.backgroundSize = 'cover';
                            preview.style.backgroundPosition = 'center';
                            preview.textContent = '';
                            document.getElementById('remove-image-btn').classList.remove('hidden');
                            document.getElementById('remove-image-btn').classList.add('flex');
                            currentProfileImage = userData.profileImage;
                        } else {
                            preview.style.backgroundImage = '';
                            preview.textContent = userData.name ? userData.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
                            document.getElementById('remove-image-btn').classList.add('hidden');
                            document.getElementById('remove-image-btn').classList.remove('flex');
                            currentProfileImage = null;
                        }
                    }
                } catch (error) {
                    console.error('Error loading profile for edit:', error);
                }
                
                document.getElementById('edit-profile-modal').classList.remove('hidden');
                document.getElementById('edit-profile-modal').classList.add('flex');
            });

            document.getElementById('close-edit-modal').addEventListener('click', () => {
                document.getElementById('edit-profile-modal').classList.add('hidden');
                document.getElementById('edit-profile-modal').classList.remove('flex');
            });

            // Search functionality
            document.getElementById('search-btn').addEventListener('click', performSearch);
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Back to conversations button
            document.getElementById('back-to-conversations').addEventListener('click', () => {
                showMobileConversationsList();
            });

            // Desktop send message form
            document.getElementById('send-message-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!currentChatId) return;
                
                const messageInput = document.getElementById('message-input');
                const messageText = messageInput.value.trim();
                
                if (!messageText) return;
                
                // Clear input immediately for better UX
                messageInput.value = '';
                
                const success = await sendMessage(currentChatId, messageText);
                if (!success) {
                    // Restore message if sending failed
                    messageInput.value = messageText;
                    alert('Failed to send message. Please try again.');
                }
            });

            // Mobile send message form
            document.getElementById('mobile-send-message-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!currentChatId) return;
                
                const messageInput = document.getElementById('mobile-message-input');
                const messageText = messageInput.value.trim();
                
                if (!messageText) return;
                
                // Clear input immediately for better UX
                messageInput.value = '';
                
                const success = await sendMessage(currentChatId, messageText);
                if (!success) {
                    // Restore message if sending failed
                    messageInput.value = messageText;
                    alert('Failed to send message. Please try again.');
                }
            });

            // Desktop image attachment handler
            document.getElementById('attach-btn').addEventListener('click', () => {
                document.getElementById('image-input').click();
            });

            // Mobile image attachment handler
            document.getElementById('mobile-attach-btn').addEventListener('click', () => {
                document.getElementById('mobile-image-input').click();
            });

            // Desktop image upload handler
            document.getElementById('image-input').addEventListener('change', async (e) => {
                await handleImageUpload(e, 'message-input');
            });

            // Mobile image upload handler
            document.getElementById('mobile-image-input').addEventListener('change', async (e) => {
                await handleImageUpload(e, 'mobile-message-input');
            });

            // Shared image upload function
            async function handleImageUpload(e, inputId) {
                const file = e.target.files[0];
                if (!file || !currentChatId) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    return;
                }

                // Validate file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size should be less than 5MB.');
                    return;
                }

                try {
                    showLoading();
                    
                    // Upload image to Firebase Storage
                    const imageUrl = await uploadImageToFirebase(file);
                    
                    // Get any text message to send with the image
                    const messageInput = document.getElementById(inputId);
                    const messageText = messageInput.value.trim();
                    
                    // Send message with image
                    const success = await sendMessage(currentChatId, messageText, imageUrl);
                    
                    if (success) {
                        messageInput.value = '';
                        e.target.value = ''; // Clear file input
                    } else {
                        alert('Failed to send image. Please try again.');
                    }
                    
                    hideLoading();
                } catch (error) {
                    hideLoading();
                    console.error('Error sending image:', error);
                    alert('Failed to upload image. Please try again.');
                }
            }

            // Image modal handlers
            document.getElementById('close-image-modal').addEventListener('click', () => {
                document.getElementById('image-modal').classList.add('hidden');
                document.getElementById('image-modal').classList.remove('flex');
            });

            // Close modal when clicking outside the image
            document.getElementById('image-modal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    document.getElementById('image-modal').classList.add('hidden');
                    document.getElementById('image-modal').classList.remove('flex');
                }
            });

            // Home page filters
            document.getElementById('apply-filters').addEventListener('click', () => {
                const typeFilter = document.getElementById('home-type-filter').value;
                const sortFilter = document.getElementById('home-sort-filter').value;
                
                let filteredPosts = [...allPosts];
                
                if (typeFilter) {
                    filteredPosts = filteredPosts.filter(post => post.type === typeFilter);
                }
                
                if (sortFilter === 'popular') {
                    filteredPosts.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                } else {
                    filteredPosts.sort((a, b) => b.createdAt - a.createdAt);
                }
                
                displayPosts(filteredPosts);
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'95e9b47ac1ab9102',t:'MTc1MjQxOTQwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
